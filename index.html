<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FinanceBot</title>
    <style>
      :root {
        --bg-light: #f5f7fa;
        --bg-dark: #1e1e2f;
        --text-light: #111;
        --text-dark: #eee;
        --primary: #2b7cff;
        --accent: #e0efff;
      }
      [data-theme="dark"] {
        --bg-light: #1e1e2f;
        --bg-dark: #f5f7fa;
        --text-light: #eee;
        --text-dark: #111;
        --accent: #2b7cff;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg-light);
        color: var(--text-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        transition: background 0.3s, color 0.3s;
      }
      .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: var(--accent);
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
      }
      #chatContainer {
        width: 100%;
        max-width: 600px;
        background: var(--bg-dark);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }
      #chatBox {
        height: 350px;
        overflow-y: auto;
        padding: 10px;
        background: var(--bg-light);
        border-radius: 10px;
        border: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
      }
      .message {
        display: flex;
        align-items: flex-end;
        gap: 10px;
      }
      .message.user {
        justify-content: flex-end;
      }
      .message.bot {
        justify-content: flex-start;
      }
      .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-size: cover;
        flex-shrink: 0;
      }
      .content {
        max-width: 75%;
        background: var(--accent);
        color: var(--text-light);
        padding: 10px 14px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
      }
      .user .content {
        background: var(--primary);
        color: white;
      }
      .timestamp {
        font-size: 0.7rem;
        color: #666;
        position: absolute;
        bottom: -16px;
        right: 10px;
      }
      #controls {
        display: flex;
        gap: 10px;
        position: relative;
      }
      #userInput {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #aaa;
      }
      #sendButton,
      #voiceBtn {
        padding: 10px 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      #sendButton:hover,
      #voiceBtn:hover {
        background: #1a5dcc;
      }
      #suggestions,
      #dropdown {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .suggestion,
      .dropdown-item {
        background: var(--accent);
        color: var(--text-light);
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
      }
      .suggestion:hover,
      .dropdown-item:hover {
        opacity: 0.8;
      }
      #dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--bg-light);
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 100%;
        max-height: 150px;
        overflow-y: auto;
        display: none;
        flex-direction: column;
        z-index: 10;
      }
      .typing {
        display: inline-block;
        width: 4px;
        height: 4px;
        background: var(--text-light);
        border-radius: 50%;
        animation: bounce 1s infinite alternate;
      }
      .typing:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes bounce {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-8px);
        }
      }
      @media (max-width: 480px) {
        #chatBox {
          height: 250px;
        }
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()">🌓</button>
    <h2>💬 Chat with FinanceBot</h2>
    <div id="chatContainer">
      <div id="chatBox"></div>
      <div id="controls">
        <div style="flex: 1; position: relative">
          <input
            id="userInput"
            placeholder="Ask a financial question..."
            autocomplete="off"
            oninput="filterDropdown()"
          />
          <div id="dropdown"></div>
        </div>
        <button id="voiceBtn" title="Speak your question 🎙️">🎤</button>
        <button id="sendButton">Send</button>
      </div>
      <div id="suggestions">
        <div class="suggestion" onclick="autoFill(this)">
          How to save money?
        </div>
        <div class="suggestion" onclick="autoFill(this)">
          Get insurance quote
        </div>
        <div class="suggestion" onclick="autoFill(this)">
          Tell me about loans
        </div>
        <div class="suggestion" onclick="autoFill(this)">Track my claim</div>
        <div class="suggestion" onclick="autoFill(this)">Bye</div>
      </div>
    </div>

    <script>
      const input = document.getElementById("userInput");
      const chatBox = document.getElementById("chatBox");
      const sendButton = document.getElementById("sendButton");
      const voiceBtn = document.getElementById("voiceBtn");
      const dropdown = document.getElementById("dropdown");

      const SUGGESTIONS = [
        "How to save money?",
        "Get insurance quote",
        "Tell me about loans",
        "Track my claim",
        "Open a savings account",
        "What is a budget?",
        "Credit score tips",
        "Mortgage options",
        "File a claim",
        "Check my balance",
      ];

      function toggleTheme() {
        document.documentElement.dataset.theme =
          document.documentElement.dataset.theme === "dark" ? "" : "dark";
      }

      function appendMessage(sender, text) {
        const msg = document.createElement("div");
        msg.className = `message ${sender}`;
        msg.innerHTML = `
        <div class="avatar" style="background-image:url('${
          sender === "user"
            ? "https://i.pravatar.cc/64?img=3"
            : "https://i.pravatar.cc/64?img=5"
        }')"></div>
        <div class="content">
          ${text}
          <div class="timestamp">${new Date().toLocaleTimeString()}</div>
        </div>`;
        chatBox.append(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;
        appendMessage("user", message);
        input.value = "";
        hideDropdown();

        const typing = document.createElement("div");
        typing.className = "message bot";
        typing.innerHTML = `<div class="avatar" style="background-image:url('https://i.pravatar.cc/64?img=5')"></div>
        <div class="content">
          <span class="typing"></span><span class="typing"></span><span class="typing"></span>
        </div>`;
        chatBox.append(typing);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });
          const data = await res.json();
          typing.remove();
          appendMessage("bot", data.response);
        } catch {
          typing.remove();
          appendMessage("bot", "Sorry, something went wrong.");
        }
      }

      function autoFill(el) {
        input.value = el.textContent;
        sendMessage();
      }

      sendButton.onclick = sendMessage;
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Voice input via Web Speech API
      voiceBtn.onclick = () => {
        const recognition = new (window.SpeechRecognition ||
          window.webkitSpeechRecognition)();
        recognition.lang = "en-US";
        recognition.start();
        recognition.onresult = (e) => {
          input.value = e.results[0][0].transcript;
          sendMessage();
        };
        recognition.onerror = () => alert("Voice input failed. Try again.");
      };

      // Live suggestion dropdown
      function filterDropdown() {
        const val = input.value.toLowerCase();
        dropdown.innerHTML = "";
        if (!val) return hideDropdown();
        const matches = SUGGESTIONS.filter((q) =>
          q.toLowerCase().includes(val)
        );
        matches.forEach((q) => {
          const div = document.createElement("div");
          div.className = "dropdown-item";
          div.textContent = q;
          div.onclick = () => {
            input.value = q;
            sendMessage();
          };
          dropdown.append(div);
        });
        dropdown.style.display = matches.length ? "flex" : "none";
      }
      function hideDropdown() {
        dropdown.style.display = "none";
      }

      // Load past session (if you have /history endpoint)
      window.onload = async () => {
        try {
          const res = await fetch("/history");
          const history = await res.json();
          history.forEach((h) => {
            appendMessage("user", h.user);
            appendMessage("bot", h.bot);
          });
        } catch {}
      };
    </script>
  </body>
</html>
